{% extends "main/base.html" %}
{%load static%}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
    <style>
  .accordion {
    background-color: #f1f1f1;
    color: #444;
    cursor: pointer;
    padding: 12px;
    width: 100%;
    text-align: left;
    border: none;
    outline: none;
    transition: 0.3s;
    font-size: 16px;
    border-radius: 6px;
  }

  .accordion.active, .accordion:hover {
    background-color: #ddd;
  }

  .panel {
    padding: 0 12px;
    display: none;
    overflow: hidden;
    margin-top: 8px;
  }

  .panel button {
    margin: 4px;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    background: #4CAF50;
    color: white;
    cursor: pointer;
    transition: 0.2s;
  }

  .panel button:hover {
    background: #45a049;
  }

  textarea {
    width: 100%;
    height: 60px;
    margin-bottom: 8px;
  }
  #ans {
    height: 300px;
  }
</style>
{% endblock extra_css %}
{% block title %}<span data-i18n="documents">Documents</span>{% endblock %}
{% block content %}
    <div class="content-area">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <textarea name="query" id="query" class="form-control" data-i18n-placeholder="query_placeholder" placeholder="–∑–∞–ø—Ä–æ—Å...">{{ q }}</textarea>
            <br>
            <input type="file" name="files" class="form-control" multiple data-i18n-placeholder="file_placeholder" placeholder="—Ñ–∞–π–ª..." accept="*/*">
            <br>
            <button type="submit" class="btn btn-primary" data-i18n="send">send</button>
        </form>
        {% if ans %}
        <form action="{% url 'save_docx' %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="title" value="{{ q }}">
            <textarea name="text" id="ans">{{ ans|safe }}</textarea>
            <button data-i18n="save_to_db">—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–∑–µ</button>
          </form>
            <!-- <button id="download-btn" data-i18n="download_docx">—Å–∫–∞—á–∞—Ç—å docx</button> -->
        {% else %}
         <button class="accordion" data-i18n="quick_queries">üìÇ –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã</button>
            <div class="panel">
                <button onclick="setQuery('“≤–∏—Å–æ–±–æ—Ç–∏ 3 –º–æ“≥–∞ –∞–∑ —Ä—É–∏ –¥–æ–¥–∞“≥–æ')" data-i18n="3_months">3-–º–æ“≥–∞</button>
                <button onclick="setQuery('“≤–∏—Å–æ–±–æ—Ç–∏ 6 –º–æ“≥–∞ –∞–∑ —Ä—É–∏ –¥–æ–¥–∞“≥–æ')" data-i18n="6_months">6-–º–æ“≥–∞</button>
                <button onclick="setQuery('“≤–∏—Å–æ–±–æ—Ç–∏ 9 –º–æ“≥–∞ –∞–∑ —Ä—É–∏ –¥–æ–¥–∞“≥–æ')" data-i18n="9_months">9-–º–æ“≥–∞</button>
                <button onclick="setQuery('“≤–∏—Å–æ–±–æ—Ç–∏ —Å–æ–ª–æ–Ω–∞ –∞–∑ —Ä—É–∏ –¥–æ–¥–∞“≥–æ')" data-i18n="annual">–°–æ–ª–æ–Ω–∞</button>
                <button onclick="setQuery('–ê—Ö–±–æ—Ä–æ—Ç“≥–æ')" data-i18n="information">–ê—Ö–±–æ—Ä–æ—Ç“≥–æ</button>
            </div>
        {% endif %}
    </div>
<script type="module">

const { Document, Packer, Paragraph, TextRun } = docx;

document.getElementById("download-btn").addEventListener("click", async () => {
    const text = document.getElementById("ans").value.trim();
    if (!text) {
        alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞!");
        return;
    }

    const lines = text.split("\n").filter(line => line.trim() !== "");
    
    const paragraphs = lines.map((line, index) => {
        if (index === 0) {
            // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫
            return new Paragraph({
                children: [
                    new TextRun({
                        text: line,
                        bold: true,
                        color: "1F4E79",
                        size: 36
                    })
                ]
            });
        } else {
            // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ ‚Äî –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
            return new Paragraph(line);
        }
    });

    const doc = new Document({
        sections: [{
            properties: {},
            children: paragraphs
        }]
    });

    const blob = await Packer.toBlob(doc);
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "document.docx";
    link.click();
    URL.revokeObjectURL(link.href);
});
</script>
<script>
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª–µ
  function setQuery(text) {
    document.getElementById("query").value = text;
  }

  // –õ–æ–≥–∏–∫–∞ –≥–∞—Ä–º–æ—à–∫–∏
  document.querySelector(".accordion").addEventListener("click", function() {
    this.classList.toggle("active");
    let panel = this.nextElementSibling;
    panel.style.display = panel.style.display === "block" ? "none" : "block";
  });
</script>
{% endblock %}